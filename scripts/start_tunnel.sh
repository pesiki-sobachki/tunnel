#!/bin/bash
# –í—ã—Ö–æ–¥–∏–º –∏–∑ —Å–∫—Ä–∏–ø—Ç–∞ –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ
set -euo pipefail

# --- –ì–ª–∞–≤–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ ---
# –£–∫–∞–∂–∏—Ç–µ –∑–¥–µ—Å—å –ø—Å–µ–≤–¥–æ–Ω–∏–º (Host) –∏–∑ –≤–∞—à–µ–≥–æ —Ñ–∞–π–ª–∞ ~/.ssh/config
SSH_ALIAS="master"
# -------------------------

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç—É–Ω–Ω–µ–ª—è ---
REMOTE_PORT="8080" # –ü–æ—Ä—Ç, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –æ—Ç–∫—Ä—ã—Ç –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ
LOCAL_PORT="3000"  # –ü–æ—Ä—Ç –≤–∞—à–µ–≥–æ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –∫—É–¥–∞ –ø–æ–π–¥–µ—Ç —Ç—Ä–∞—Ñ–∏–∫
# -------------------------

echo "üîç –ß–∏—Ç–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è —Ö–æ—Å—Ç–∞ '${SSH_ALIAS}' –∏–∑ ~/.ssh/config..."

# –ò—Å–ø–æ–ª—å–∑—É–µ–º ssh -G –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Ö–æ—Å—Ç–∞.
# –≠—Ç–æ –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–±, –∫–æ—Ç–æ—Ä—ã–π —É—á–∏—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –ø—Ä–∞–≤–∏–ª–∞ –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞.
REMOTE_USER=$(ssh -G "${SSH_ALIAS}" | awk '/^user / { print $2 }')
REMOTE_HOST=$(ssh -G "${SSH_ALIAS}" | awk '/^hostname / { print $2 }')

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω—ã
if [ -z "$REMOTE_USER" ] || [ -z "$REMOTE_HOST" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ö–æ—Å—Ç–∞ '${SSH_ALIAS}'." >&2
    echo "   –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–ø–∏—Å–∞–Ω –≤ –≤–∞—à–µ–º —Ñ–∞–π–ª–µ ~/.ssh/config." >&2
    exit 1
fi

echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∞: ${REMOTE_USER}@${REMOTE_HOST}"
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º SSH-—Ç—É–Ω–Ω–µ–ª—å..."
echo "   –£–¥–∞–ª–µ–Ω–Ω—ã–π –∞–¥—Ä–µ—Å: ${REMOTE_HOST}:${REMOTE_PORT}"
echo "   –õ–æ–∫–∞–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å:  localhost:${LOCAL_PORT}"
echo "   –ù–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏."

# –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç—É–Ω–Ω–µ–ª—è. SSH —Å–∞–º –ø–æ–¥—Å—Ç–∞–≤–∏—Ç –Ω—É–∂–Ω—ã–π –∫–ª—é—á, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Ö–æ—Å—Ç –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞.
# -N: –ù–µ –≤—ã–ø–æ–ª–Ω—è—Ç—å —É–¥–∞–ª–µ–Ω–Ω—É—é –∫–æ–º–∞–Ω–¥—É. –¢–æ–ª—å–∫–æ –ø—Ä–æ–±—Ä–æ—Å –ø–æ—Ä—Ç–æ–≤.
# -o ServerAliveInterval=30: –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å "keep-alive" –ø–∞–∫–µ—Ç—ã –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫, —á—Ç–æ–±—ã —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —Ä–≤–∞–ª–æ—Å—å.
# -o ServerAliveCountMax=3: –°—á–∏—Ç–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–Ω—ã–º –ø–æ—Å–ª–µ 3 –Ω–µ–æ—Ç–≤–µ—á–µ–Ω–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤.
# -R: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –æ–±—Ä–∞—Ç–Ω—ã–π (Remote) —Ç—É–Ω–Ω–µ–ª—å.
ssh -N \
    -o "ServerAliveInterval=30" \
    -o "ServerAliveCountMax=3" \
    -R "${REMOTE_PORT}:localhost:${LOCAL_PORT}" \
    "${SSH_ALIAS}"

echo "üîå –¢—É–Ω–Ω–µ–ª—å –∑–∞–∫—Ä—ã—Ç."
