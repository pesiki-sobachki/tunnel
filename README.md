# Простой и надежный обратный SSH-туннель

Этот репозиторий предоставляет скрипты и подробное руководство для создания обратного SSH-туннеля. Это позволяет открыть публичный доступ к сервису, запущенному на вашей локальной машине (или за NAT), через удаленный сервер с публичным IP-адресом.

В отличие от аналогов (ngrok, localtunnel), это решение полностью **self-hosted**: вы используете собственный сервер и стандартные инструменты OpenSSH, сохраняя полный контроль над данными и безопасностью.

## Содержание

- [Ключевые особенности](#ключевые-особенности)
- [Как это работает](#как-это-работает)
- [Частые сценарии использования](#частые-сценарии-использования)
- [Шаг 1: Настройка сервера](#шаг-1-настройка-сервера)
  - [Важный параметр: `GatewayPorts`](#важный-параметр-gatewayports)
- [Шаг 2: Способы подключения](#шаг-2-способы-подключения)
  - [Способ 1: Обычная команда SSH (без скриптов)](#способ-1-обычная-команда-ssh-без-скриптов)
  - [Способ 2: Через скрипт `start_tunnel.sh` (рекомендуемый)](#способ-2-через-скрипт-start_tunnelsh-рекомендуемый)
  - [Способ 3: Через утилиту `sshm`](#способ-3-через-утилиту-sshm)
- [Повышение безопасности: Ограничение прав SSH-ключа](#повышение-безопасности-ограничение-прав-ssh-ключа)
- [Решение проблем (Troubleshooting)](#решение-проблем-troubleshooting)

## Ключевые особенности

- **Zero Dependencies:** Работает на чистом `ssh`. Не требует установки `autossh` или других сторонних утилит.
- **Умная конфигурация:** Скрипт автоматически подтягивает адрес хоста, пользователя и ключи из вашего файла `~/.ssh/config`.
- **Безопасность:** Использует аутентификацию по SSH-ключам. Описан метод ограничения прав ключа для максимальной безопасности.
- **Универсальность:** Пробрасывает любой TCP-трафик (HTTP, базы данных, игры, IoT).

## Как это работает

Вы инициируете SSH-соединение с вашей локальной машины на удаленный сервер и "просите" его начать слушать определенный публичный порт. Весь трафик, приходящий на этот порт, сервер будет перенаправлять (туннелировать) через зашифрованное SSH-соединение обратно на вашу локальную машину на указанный вами порт.

```text
                  <-- Интернет-трафик -->
                         |
+-----------------------------------------------------------+
|                      Удаленный сервер                     |
|                                                           |
|    Файрвол          +-----------------+                   |
|       |             |   Порт :8080    |                   |
|    (Порт 80) <----->| (или любой другой) |                |
+---------------------|-----------------|-------------------+
                      |      ^
                      |      | (Весь трафик перенаправляется)
                      v      |
+-----------------------------------------------------------+
|            Обратный SSH-туннель (Зашифровано)             |
+-----------------------------------------------------------+
                      |      ^
                      |      | (Соединение инициируется отсюда)
                      v      |
+-----------------------------------------------------------+
|                      Локальная машина                     |
|                                                           |
|    +------------------------------------------------+     |
|    | Ваше приложение (веб-сервер, БД и т.д.)        |     |
|    | Слушает на localhost:3000 (или любом другом)   |     |
|    +------------------------------------------------+     |
+-----------------------------------------------------------+
```

## Частые сценарии использования

- **Веб-разработка:** Демонстрация локального сайта заказчику.
- **Webhooks:** Тестирование интеграций (Stripe, Telegram Bots, GitHub).
- **Удаленный доступ:** Временное открытие доступа к локальной базе данных, Jupyter Notebook или игровому серверу.

---

## Шаг 1: Настройка сервера

Перед созданием туннеля необходимо убедиться, что ваш удаленный SSH-сервер настроен правильно.

### Важный параметр: `GatewayPorts`

Этот параметр в конфигурации SSH-сервера (`/etc/ssh/sshd_config`) определяет, на каких IP-адресах будет открыт удаленный порт туннеля.

- `GatewayPorts no` (часто по умолчанию): Порт будет слушать только на `localhost` (`127.0.0.1`) сервера. Это означает, что туннель будет доступен **только с самого сервера**, но не из внешнего мира.
- `GatewayPorts yes`: Порт будет слушать на всех сетевых интерфейсах сервера (`0.0.0.0`), делая его **доступным из Интернета**.
- `GatewayPorts clientspecified`: Клиент сам может выбрать, на каком IP-адресе открыть порт.

**Для публичного доступа вам нужно значение `yes`!**

**Как проверить и изменить:**

1.  Подключитесь к вашему удаленному серверу по SSH.
2.  Выполните команду, чтобы найти настройку:
    ```bash
    grep GatewayPorts /etc/ssh/sshd_config
    ```
3.  Если значение `no` или строка закомментирована (`#`), откройте файл с правами суперпользователя:
    ```bash
    sudo nano /etc/ssh/sshd_config
    ```
4.  Найдите строку `GatewayPorts` и измените ее на:
    ```
    GatewayPorts yes
    ```
5.  Сохраните файл и **обязательно перезапустите SSH-сервис**:
    ```bash
    sudo systemctl restart sshd
    ```

> **Примечание:** Также убедитесь, что файрвол на сервере (например, `ufw`, `firewalld` или файрвол вашего облачного провайдера) разрешает входящие соединения на тот порт, который вы планируете использовать (например, `8080`).

---

## Шаг 2: Способы подключения

Выберите наиболее удобный для вас способ.

### Способ 1: Обычная команда SSH (без скриптов)

Это самый простой и быстрый способ создать туннель для разовой задачи.

Откройте терминал на **вашей локальной машине** и выполните команду:

```bash
ssh -N -R 8080:localhost:3000 user@your_server_ip
```

Разберем команду:

- `-N`: Не выполнять никаких команд на удаленном сервере. Просто установить соединение для проброса портов.
- `-R 8080:localhost:3000`: Главный флаг.
  - `R` означает **R**emote forwarding (обратный туннель).
  - `8080` — порт, который будет открыт на **удаленном** сервере.
  - `localhost:3000` — адрес и порт на **локальной** машине, куда будет перенаправляться трафик.
- `user@your_server_ip`: Ваши учетные данные для подключения к серверу.

Теперь любой, кто зайдет на `http://your_server_ip:8080`, увидит ваше приложение, работающее на `localhost:3000`.

### Способ 2: Через скрипт `start_tunnel.sh` (рекомендуемый)

Этот способ идеален для частого использования. Он использует файл `~/.ssh/config` для удобного управления подключениями.

**1. Настройте `~/.ssh/config` на локальной машине**

Откройте файл `~/.ssh/config` (если его нет, создайте) и добавьте псевдоним для вашего сервера:

```
# Псевдоним для подключения к серверу
Host my-tunnel-server
    HostName ip_вашего_сервера
    User ваш_логин_на_сервере
    IdentityFile ~/.ssh/id_rsa # Путь к вашему приватному SSH-ключу
```

- `Host my-tunnel-server`: Удобное короткое имя. Можете выбрать любое.

**2. Настройте и запустите скрипт**

1.  Откройте файл `scripts/start_tunnel.sh` и укажите ваш псевдоним и порты:
    ```bash
    SSH_ALIAS="my-tunnel-server"
    REMOTE_PORT="8080"
    LOCAL_PORT="3000"
    ```
2.  Сделайте скрипт исполняемым и запустите его:
    `bash
chmod +x ./scripts/start_tunnel.sh
./scripts/start_tunnel.sh
`
    Скрипт автоматически подхватит все настройки из `~/.ssh/config` и установит соединение.

### Способ 3: Через утилиту `sshm`

Если вы используете менеджер SSH-конфигураций [sshm](https://github.com/sshm-cli/sshm), создание туннеля становится еще проще.

1.  Убедитесь, что у вас настроен псевдоним в `~/.ssh/config` (как в Способе 2).
2.  Запустите `sshm` с вашим псевдонимом:
    ```bash
    sshm my-tunnel-server
    ```
3.  В интерактивном меню `sshm` нажмите клавишу `f` (forward port).
4.  `sshm` предложит настроить туннель:
    - `Forward type`: Выберите `Remote` (обратный).
    - `Remote host`: Оставьте `localhost`.
    - `Remote port`: Введите порт для сервера (например, `8080`).
    - `Local port`: Введите порт вашего локального приложения (например, `3000`).
5.  Нажмите Enter, и туннель будет создан.

---

## Повышение безопасности: Ограничение прав SSH-ключа

Для автоматизированных скриптов рекомендуется использовать SSH-ключ с минимально необходимыми правами. Мы можем ограничить ключ так, чтобы он мог **только создавать туннель** и ничего больше.

1.  На **удаленном сервере** откройте файл `~/.ssh/authorized_keys` вашего пользователя.
2.  Найдите строку с вашим публичным ключом. Она выглядит примерно так:
    `ssh-rsa AAAAB3NzaC1yc2EAAA... user@workstation`
3.  **В самое начало этой строки** добавьте следующие опции:

    ```
    restrict,command="/bin/false",permitopen="localhost:8080",permitopen="localhost:8081"
    ```

    - `restrict`: Запрещает все возможности (исполнение команд, X11 forwarding и т.д.).
    - `command="/bin/false"`: Дополнительно гарантирует, что никакая команда не будет выполнена.
    - `permitopen="localhost:8080"`: **Разрешает** проброс трафика на `localhost` сервера на порт `8080`.
    - Вы можете указать несколько разрешенных портов, перечисляя опции `permitopen`.

**Пример итоговой строки в `authorized_keys`:**

```
restrict,command="/bin/false",permitopen="localhost:8080" ssh-rsa AAAAB3NzaC1yc2EAAA... user@workstation
```

Теперь, даже если этот ключ будет скомпрометирован, злоумышленник сможет только создавать туннель на разрешенный порт и не получит доступ к командной строке сервера.

---

## Решение проблем (Troubleshooting)

**1. Туннель доступен только с сервера (`localhost:8080`), но не по публичному IP.**

- **Проблема:** Скорее всего, на сервере установлено `GatewayPorts no`.
- **Решение:** См. раздел [Важный параметр: `GatewayPorts`](#важный-параметр-gatewayports). Установите `GatewayPorts yes` в `/etc/ssh/sshd_config` и перезапустите `sshd`.

**2. Соединение не устанавливается, ошибка "Connection refused".**

- **Проблема:** Файрвол на сервере (или у облачного провайдера) блокирует порт, который вы хотите использовать (`REMOTE_PORT`).
- **Решение:** Добавьте правило, разрешающее входящий TCP-трафик на этот порт.
  - Для `ufw`: `sudo ufw allow 8080/tcp`
  - Проверьте также настройки безопасности в панели управления вашего хостинга (AWS, DigitalOcean, etc.).

**3. Ошибка "bind: Address already in use" при запуске туннеля.**

- **Проблема:** Другой процесс на **удаленном сервере** уже использует порт, который вы указали в `REMOTE_PORT`.
- **Решение:** Выберите другой `REMOTE_PORT` или найдите и остановите процесс, занимающий порт на сервере:
  ```bash
  # На удаленном сервере
  sudo lsof -i :8080
  ```

**4. Скрипт выдает ошибку "не удалось получить данные для хоста".**

- **Проблема:** Псевдоним, указанный в `SSH_ALIAS` в скрипте, не найден или некорректно описан в файле `~/.ssh/config`.
- **Решение:** Проверьте, что имя `Host` в `~/.ssh/config` в точности совпадает со значением `SSH_ALIAS` в `start_tunnel.sh`.
